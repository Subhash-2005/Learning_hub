<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile - LearnHub</title>
    <link rel="stylesheet" href="profile.css">
</head>
<body>
    <div class="profile-container">
        <div class="loading-overlay" id="loadingOverlay">
            <div class="loading-spinner"></div>
        </div>
        
        <h1>User Profile</h1>
        
        <div class="profile-avatar" id="profileAvatar">
            üë§
        </div>
        
        <div id="error-message" class="error-message"></div>
        <div id="success-message" class="success-message"></div>
        
        <div class="form-group">
            <label for="profileName">Name</label>
            <input type="text" id="profileName" placeholder="Enter your name">
            <span class="input-icon">‚úèÔ∏è</span>
        </div>
        
        <div class="form-group">
            <label for="profileEmail">Email Address</label>
            <input type="email" id="profileEmail" disabled>
            <span class="input-icon">üìß</span>
        </div>
        
        <div class="profile-stats">
            <div class="stat-card">
                <span class="stat-number" id="coursesCount">0</span>
                <span class="stat-label">Courses</span>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="completedCount">0</span>
                <span class="stat-label">Completed</span>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="progressAvg">0%</span>
                <span class="stat-label">Progress</span>
            </div>
        </div>
        
        <div class="button-container">
            <button id="saveChangesBtn">Save Changes</button>
            <button id="logoutBtn">Logout</button>
        </div>
    </div>

    <script>
        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            overlay.style.display = show ? 'flex' : 'none';
        }

        function showMessage(message, isError = false) {
            const errorDiv = document.getElementById('error-message');
            const successDiv = document.getElementById('success-message');
            
            if (isError) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                successDiv.style.display = 'none';
            } else {
                successDiv.textContent = message;
                successDiv.style.display = 'block';
                errorDiv.style.display = 'none';
            }
            
            setTimeout(() => {
                errorDiv.style.display = 'none';
                successDiv.style.display = 'none';
            }, 5000);
        }

        function updateProfileAvatar(name) {
            const avatar = document.getElementById('profileAvatar');
            if (name && name.length > 0) {
                avatar.textContent = name.charAt(0).toUpperCase();
            } else {
                avatar.textContent = 'üë§';
            }
        }

        function updateStats(profileData) {
            const coursesCount = profileData.enrolledCourses ? profileData.enrolledCourses.length : 0;
            const completedCount = profileData.enrolledCourses ? 
                profileData.enrolledCourses.filter(course => course.progress === 100).length : 0;
            const totalProgress = profileData.enrolledCourses && profileData.enrolledCourses.length > 0 ? 
                profileData.enrolledCourses.reduce((sum, course) => sum + course.progress, 0) : 0;
            const avgProgress = coursesCount > 0 ? Math.round(totalProgress / coursesCount) : 0;

            document.getElementById('coursesCount').textContent = coursesCount;
            document.getElementById('completedCount').textContent = completedCount;
            document.getElementById('progressAvg').textContent = avgProgress + '%';
        }

        async function loadUserProfile() {
            showLoading(true);
            try {
                const response = await fetch("https://learning-hub-oowi.onrender.com/profile", {
                    method: "GET",
                    credentials: "include"
                });
                const data = await response.json();
                if (!response.ok) {
                    showMessage("Session expired. Please login again.", true);
                    setTimeout(() => {
                        window.location.href = "login.html";
                    }, 2000);
                    return;
                }
                document.getElementById("profileName").value = data.name;
                document.getElementById("profileEmail").value = data.email;
                updateProfileAvatar(data.name);
                updateStats(data);
                localStorage.setItem("loggedInUser", JSON.stringify(data));
            } catch (error) {
                console.error("Error fetching profile:", error);
                showMessage("Failed to load profile. Please try again.", true);
            } finally {
                showLoading(false);
            }
        }

        document.getElementById("saveChangesBtn").addEventListener("click", async function() {
            const newName = document.getElementById("profileName").value.trim();
            if (!newName) {
                showMessage("Name cannot be empty.", true);
                return;
            }

            const button = this;
            const originalText = button.textContent;
            button.textContent = "Saving...";
            button.disabled = true;

            try {
                const response = await fetch("https://learning-hub-oowi.onrender.com/update-profile", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ name: newName }),
                    credentials: "include"
                });
                const data = await response.json();
                if (!response.ok) {
                    showMessage(data.message, true);
                    return;
                }
                showMessage("Profile updated successfully!");
                localStorage.setItem("loggedInUser", JSON.stringify(data));
                document.getElementById("profileName").value = data.name;
                updateProfileAvatar(data.name);
            } catch (error) {
                console.error("Profile Update Error:", error);
                showMessage("Failed to update profile. Please try again.", true);
            } finally {
                button.textContent = originalText;
                button.disabled = false;
            }
        });

        document.getElementById("logoutBtn").addEventListener("click", async function() {
            const button = this;
            const originalText = button.textContent;
            button.textContent = "Logging out...";
            button.disabled = true;

            try {
                await fetch("hhttps://learning-hub-oowi.onrender.com/logout", {
                    method: "POST",
                    credentials: "include"
                });
                
                localStorage.clear();
                showMessage("Logged out successfully!");
                setTimeout(() => {
                    window.location.href = "login.html";
                }, 1000);
            } catch (error) {
                console.error("Logout error:", error);
                button.textContent = originalText;
                button.disabled = false;
            }
        });

        document.addEventListener("DOMContentLoaded", loadUserProfile);
    </script>
</body>
</html>